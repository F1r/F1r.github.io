<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.3"><link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="PWN,HEAP,"><link rel="alternate" href="/atom.xml" title="Flier's Blog" type="application/atom+xml"><meta name="description" content="Heap ExploitationBase Knowledgemalloc_chunk1234567891011121314struct malloc_chunk&amp;#123;    INTERNAL_SIZE_T        mchunk_prev_size;    /*Size of previous chunk (if free)        */    INTERNAL_SIZE_T"><meta name="keywords" content="PWN,HEAP"><meta property="og:type" content="article"><meta property="og:title" content="Heap-Exploitation-base-knowledge-notes"><meta property="og:url" content="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/index.html"><meta property="og:site_name" content="Flier&#39;s Blog"><meta property="og:description" content="Heap ExploitationBase Knowledgemalloc_chunk1234567891011121314struct malloc_chunk&amp;#123;    INTERNAL_SIZE_T        mchunk_prev_size;    /*Size of previous chunk (if free)        */    INTERNAL_SIZE_T"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/3589312.png"><meta property="og:image" content="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/3665609.png"><meta property="og:image" content="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/6875765.png"><meta property="og:updated_time" content="2017-10-24T14:11:39.062Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Heap-Exploitation-base-knowledge-notes"><meta name="twitter:description" content="Heap ExploitationBase Knowledgemalloc_chunk1234567891011121314struct malloc_chunk&amp;#123;    INTERNAL_SIZE_T        mchunk_prev_size;    /*Size of previous chunk (if free)        */    INTERNAL_SIZE_T"><meta name="twitter:image" content="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/3589312.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/"><title>Heap-Exploitation-base-knowledge-notes | Flier's Blog</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Flier's Blog</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">F1r</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i><br> 站点地图</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="F1r"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Flier's Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Heap-Exploitation-base-knowledge-notes</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-24T21:58:21+08:00">2017-10-24</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/PWN/" itemprop="url" rel="index"><span itemprop="name">PWN</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span><a href="/2017/10/24/Heap-Exploitation-base-knowledge-notes/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/10/24/Heap-Exploitation-base-knowledge-notes/" itemprop="commentCount"></span></a></span> <span class="post-meta-divider">|</span> <span class="page-pv">本文总阅读量<span class="busuanzi-value" id="busuanzi_value_page_pv"></span> 次</span></div></header><div class="post-body" itemprop="articleBody"><h1 id="Heap-Exploitation"><a href="#Heap-Exploitation" class="headerlink" title="Heap Exploitation"></a>Heap Exploitation</h1><h2 id="Base-Knowledge"><a href="#Base-Knowledge" class="headerlink" title="Base Knowledge"></a>Base Knowledge</h2><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>&#123;</span></div><div class="line">    INTERNAL_SIZE_T        mchunk_prev_size;    <span class="comment">/*Size of previous chunk (if free)        */</span></div><div class="line">    INTERNAL_SIZE_T        mchunk_size;         <span class="comment">/*Size in bytes, including overhead        */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>                    <span class="comment">/*double links  ----  used only if free.*/</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bf</span>;</span></div><div class="line">    <span class="comment">/*only used for large blocks: pointer to next larger size*/</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">&lt;!-- more --&gt;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">mchunkptr</span>;</span></div></pre></td></tr></table></figure><h3 id="Allocated-chunk"><a href="#Allocated-chunk" class="headerlink" title="Allocated chunk"></a>Allocated chunk</h3><p><img src="/2017/10/24/Heap-Exploitation-base-knowledge-notes/3589312.png" alt=""></p><p><strong>mem</strong> is the pointer which is returned to the user.</p><h3 id="Free-chunk"><a href="#Free-chunk" class="headerlink" title="Free chunk"></a>Free chunk</h3><p><img src="/2017/10/24/Heap-Exploitation-base-knowledge-notes/3665609.png" alt=""></p><p>Free chunks maintain themselves in a circular doubly linked list.</p><ol><li><font color="red"><strong>P(PREV_INUSE)</strong></font>: 0 when previous chunk (not the prev chunk in the linked list, but the one directly before it in memory) is free (and hence the size of previous chunk is stored in the first field). The very first chunk allocated has this bit set. If the bit set to 1, we cannot determine the size of the previous chunk.</li><li><font color="red"><strong>M(IS_MMAPPED)</strong></font>: The chunk is obtained through <strong>mmap</strong>. The other two bits are ignored. <strong>mmapped</strong> chunks are neither in an <strong>arena</strong>, not adjacent to a free chunk.</li><li><font color="red"><strong>A(NON_MAIN_ARENA)</strong></font>: 0 for chunks in the main arena. Each thread spawned received its own <strong>arena</strong> and for those chunks, this bit is set.</li></ol><p>PS: <font color="blue">fastbins are not included in the set described above.</font></p><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p>This structure represents the details of an Arena. The main threads arena is a global variable and not part of the heap segment.Arena headers( <strong>malloc_chunk</strong> structures) for other threads are themselves stored in the heap segment. Non main arena can have multiple heaps associated with them.</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span>    <span class="title">malloc_state</span> &#123;</span></div><div class="line">    __libc_lock_define (, mutex);</div><div class="line">    <span class="keyword">int</span> flags;</div><div class="line">    <span class="comment">/* Fastbins */</span></div><div class="line">    mfastbinptr fastbinsY[NFASTBINS];</div><div class="line">    <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></div><div class="line">    mchunkptr top;</div><div class="line">    <span class="comment">/* The remainder from the most recent split of a small request */</span></div><div class="line">    mchunkptr last_remainder;</div><div class="line">    <span class="comment">/* Normal bins packed as described above */</span></div><div class="line">    mchunkptr bin[NBINS * <span class="number">2</span> - <span class="number">2</span>];</div><div class="line">    </div><div class="line">    <span class="comment">/* Bitmap of bins */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> binmap[BINMAPSIZE];</div><div class="line">    </div><div class="line">    <span class="comment">/* Linked list */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></div><div class="line">    <span class="comment">/* Linked list for free arenas. Access to this field is serialized by free_list_lock in arena,c, */</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></div><div class="line">    <span class="comment">/* Number of threands attached to this arena. 0 if the arena is on the free list. Access to this field is serialized by free_list_lock in arena.c. */</span></div><div class="line">    INTERNAL_SIZE_T attached_threads;</div><div class="line">    <span class="comment">/* Memory allocated from the system in this arena. */</span></div><div class="line">    INTERNAL_SIZE_T system_mem;</div><div class="line">    INTERNAL_SIZE_T max_system_mem;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">mstate</span>;</span></div></pre></td></tr></table></figure><h3 id="Bins-and-Chunks"><a href="#Bins-and-Chunks" class="headerlink" title="Bins and Chunks"></a>Bins and Chunks</h3><p>A bin is a list (doubly or singly linked list) of free (non-allocated) chunks. Bins are differentiated based on the size of chunks they contain:</p><ol><li>Fastbin</li><li>Unsorted bin</li><li>Small bin</li><li>Large bin</li></ol><p>PS: Unsorted, small and large bins are maintained using a single array:<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> * <span class="title">mchunkptr</span>;</span></div><div class="line">mchunkptr bins[]; <span class="comment">//Array of pointers to chunks</span></div></pre></td></tr></table></figure><p></p><h4 id="Fastbins"><a href="#Fastbins" class="headerlink" title="Fastbins"></a>Fastbins</h4><p>The 10 types of fastbins each have chunks of size: 16, 24, 32, 40, 48, 56, 64, 72, 80 and 88. Sizes mentioned here include metadata as well. To store chunks, 4 fewer bytes will be available (on a platform where pointers use 4 bytes). Only <strong>prev_size</strong> and <strong>size</strong> field of this chunk will hold meta data for allocated chunks.</p><p>PS: <font color="blue">No two contiguous free fast chunks coalesce together, which is not different with normal bins.</font></p><h4 id="Unsorted-bin"><a href="#Unsorted-bin" class="headerlink" title="Unsorted bin"></a>Unsorted bin</h4><p>There is only 1 unsorted bin. Small and large chunks, when freed, end up in this bin. The primary purpose of this bin is to act as a cache layer to speed up allocation and deallocation requests.</p><h4 id="Small-bins"><a href="#Small-bins" class="headerlink" title="Small bins"></a>Small bins</h4><p>Each small bin maintains a <strong>doubly-linked</strong> list. Insertions happen at “HEAD” while removals happen at the ‘TAIL’(in a FIFO manner).<br>The 64 bins have sizes: 16, 24, …… 504 bytes.</p><p>PS: <font color="blue">While freeing, small chunks may be coalesced toghether before ending up in unsorted bins.</font></p><h4 id="Large-bins"><a href="#Large-bins" class="headerlink" title="Large bins"></a>Large bins</h4><p>Each large bin maintains a <strong>doubly-linked</strong> list. A particular chunks of different sizes, sorted in decreasing order. Insertions and removal happed at any position within the list.</p><p>The first 32 bins contain chunks which are 64 bytes apart:</p><p>1st bin: 512 - 568 bytes<br>2nd bin: 576 - 632 bytes<br>…<br>…</p><p><img src="/2017/10/24/Heap-Exploitation-base-knowledge-notes/6875765.png" alt=""></p><h4 id="Top-chunk"><a href="#Top-chunk" class="headerlink" title="Top chunk"></a>Top chunk</h4><p>It is the chunk which borders the top of an arena. While servicing ‘malloc’ requests, it is used as the last resort. If still more size is required, it can grow using the <strong>sbrk</strong> system call. The <strong>PREV_INUSE</strong> flag is always set for the top chunk.</p><h4 id="Last-remainder-chunk"><a href="#Last-remainder-chunk" class="headerlink" title="Last remainder chunk"></a>Last remainder chunk</h4><p>It is the chunk obtained from the last split. Sometimes, when exact size chunks are not available, bigger chunks are split into two. One part is returned to user whereas the other becomes the last remainder chunk.</p><h3 id="Internal-functions"><a href="#Internal-functions" class="headerlink" title="Internal functions"></a>Internal functions</h3><h4 id="arena-get-ar-ptr-size"><a href="#arena-get-ar-ptr-size" class="headerlink" title="arena_get(ar_ptr, size)"></a>arena_get(ar_ptr, size)</h4><p>Acquires an arena and locks the corresponding mutex.</p><ul><li><strong>ar_ptr</strong> is set to the pointer to the corresponding arena.</li><li><strong>size</strong> is set to how much memory will be required immediately.</li></ul><h4 id="sysmalloc-TODO"><a href="#sysmalloc-TODO" class="headerlink" title="sysmalloc [TODO]"></a>sysmalloc [TODO]</h4><p>sysmalloc handles malloc cases requiring more memory from the system.<br>On entry, it is assumed that assumed that av->top does not have enough space to service request for nb bytes, thus requiring that av->top be extended or replaced.</p><h4 id="void-alloc-perturb-char-p-size-t-n"><a href="#void-alloc-perturb-char-p-size-t-n" class="headerlink" title="void alloc_perturb(char *p, size_t n)"></a>void alloc_perturb(char *p, size_t n)</h4><p>If <strong>perturb_byte</strong> (tunable parameter for malloc using <strong>M_PERTURB</strong>) is non-zero (by default it is 0), sets the <strong>n</strong> bytes pointed to by <strong>p</strong> to be equal to <strong>perturb_byte</strong> ^ 0xff.</p><blockquote><p>调用alloc_perturb对用户使用的内存进行初始化，之后就会返回该内存的指针（在<strong>_int_malloc(mstate av, size_t bytes)</strong>函数中)</p></blockquote><h4 id="void-free-perturb-char-p-size-t-n"><a href="#void-free-perturb-char-p-size-t-n" class="headerlink" title="void free_perturb(char *p, size_t n)"></a>void free_perturb(char *p, size_t n)</h4><p>If <strong>perturb_byte</strong> (tunable parameter for malloc using <strong>M_PERTURB</strong>) is non-zero (by default it is 0), sets the <strong>n</strong> bytes pointed to by <strong>p</strong> to be equal to <strong>perturb_byte</strong>.</p><h4 id="void-malloc-init-state-mstate-av"><a href="#void-malloc-init-state-mstate-av" class="headerlink" title="void malloc_init_state(mstate av)"></a>void malloc_init_state(mstate av)</h4><ol><li>For non fast bins, create empty circular linked lists for each bin.</li><li>Set <strong>FASTCHUNKS_BIT</strong> flag for av.</li><li>Initialize <strong>av-&gt;top</strong> to the first unsorted chunk.</li></ol><h4 id="unlink-AV-P-BK-FD"><a href="#unlink-AV-P-BK-FD" class="headerlink" title=" unlink(AV, P, BK, FD)"></a> <font color="red">unlink(AV, P, BK, FD)</font></h4><p>This is a defined macro which removes a chunk from a bin.</p><ol><li>Check if chunk size is equal to the previous size set in the next chunk.</li><li>Check if <strong>P-&gt;fd-&gt;bk == P</strong> and <strong>P-&gt;bk-&gt;fd == P</strong>.</li><li>Adjust forward and backward pointers of neighboring chunks (in list) to facilitate remova:<ol><li>Set P->fd->bk = P->bk</li><li>Set P->bk->fd = P->fd</li></ol></li></ol><h4 id="void-malloc-consolidate-master-av"><a href="#void-malloc-consolidate-master-av" class="headerlink" title="void malloc_consolidate(master av)"></a>void malloc_consolidate(master av)</h4><p>This is <font size="red">a specialized version of free()</font>.</p><blockquote><p>malloc_consolidate函数主要完成以下几个功能：</p><ol><li>首先判断当前malloc_state结构体中的fast bin是否为空，如果为空就说明整个malloc_state都没有完成初始化，需要对malloc_state进行初始化。</li><li>malloc_state的初始化操作由函数malloc_init_state(av)完成，该函数先初始化除fast bin之外的所有的bins，再初始化fast bins。</li></ol></blockquote></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/PWN/" rel="tag"># PWN</a> <a href="/tags/HEAP/" rel="tag"># HEAP</a></div><div class="post-widgets"><div id="needsharebutton-postbottom"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/10/21/PLAY-WITH-LINUX-HEAP-notes/" rel="next" title="PLAY_WITH_LINUX_HEAP-notes"><i class="fa fa-chevron-left"></i> PLAY_WITH_LINUX_HEAP-notes</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article><div class="post-spread"><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="//bdimg.share.baidu.com/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">F1r</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">2</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">5</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/F1r" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:fliergoo@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-google"></i> E-Mail</a></span><span class="links-of-author-item"><a href="http://bestwing.me" target="_blank" title="Swing'Blog"><i class="fa fa-fw fa-globe"></i> Swing'Blog</a></span><span class="links-of-author-item"><a href="http://www.bendawang.site" target="_blank" title="Bendawang"><i class="fa fa-fw fa-globe"></i> Bendawang</a></span><span class="links-of-author-item"><a href="https://burnegg.com/" target="_blank" title="burnegg"><i class="fa fa-fw fa-globe"></i> burnegg</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Heap-Exploitation"><span class="nav-number">1.</span> <span class="nav-text">Heap Exploitation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Base-Knowledge"><span class="nav-number">1.1.</span> <span class="nav-text">Base Knowledge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc-chunk"><span class="nav-number">1.1.1.</span> <span class="nav-text">malloc_chunk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Allocated-chunk"><span class="nav-number">1.1.2.</span> <span class="nav-text">Allocated chunk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Free-chunk"><span class="nav-number">1.1.3.</span> <span class="nav-text">Free chunk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc-state"><span class="nav-number">1.1.4.</span> <span class="nav-text">malloc_state</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bins-and-Chunks"><span class="nav-number">1.1.5.</span> <span class="nav-text">Bins and Chunks</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Fastbins"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">Fastbins</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Unsorted-bin"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">Unsorted bin</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Small-bins"><span class="nav-number">1.1.5.3.</span> <span class="nav-text">Small bins</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Large-bins"><span class="nav-number">1.1.5.4.</span> <span class="nav-text">Large bins</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Top-chunk"><span class="nav-number">1.1.5.5.</span> <span class="nav-text">Top chunk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Last-remainder-chunk"><span class="nav-number">1.1.5.6.</span> <span class="nav-text">Last remainder chunk</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Internal-functions"><span class="nav-number">1.1.6.</span> <span class="nav-text">Internal functions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#arena-get-ar-ptr-size"><span class="nav-number">1.1.6.1.</span> <span class="nav-text">arena_get(ar_ptr, size)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sysmalloc-TODO"><span class="nav-number">1.1.6.2.</span> <span class="nav-text">sysmalloc [TODO]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-alloc-perturb-char-p-size-t-n"><span class="nav-number">1.1.6.3.</span> <span class="nav-text">void alloc_perturb(char *p, size_t n)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-free-perturb-char-p-size-t-n"><span class="nav-number">1.1.6.4.</span> <span class="nav-text">void free_perturb(char *p, size_t n)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-malloc-init-state-mstate-av"><span class="nav-number">1.1.6.5.</span> <span class="nav-text">void malloc_init_state(mstate av)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unlink-AV-P-BK-FD"><span class="nav-number">1.1.6.6.</span> <span class="nav-text">unlink(AV, P, BK, FD)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-malloc-consolidate-master-av"><span class="nav-number">1.1.6.7.</span> <span class="nav-text">void malloc_consolidate(master av)</span></a></li></ol></li></ol></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2017</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">F1r</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div> <span class="post-meta-divider">|</span><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div><div id="needsharebutton-float"><span class="btn"><i class="fa fa-share-alt" aria-hidden="true"></i></span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script id="dsq-count-scr" src="https://F1r-github-io.disqus.com/count.js" async></script><script type="text/javascript">var disqus_config=function(){this.page.url="http://blog.flier.net.cn/2017/10/24/Heap-Exploitation-base-knowledge-notes/",this.page.identifier="2017/10/24/Heap-Exploitation-base-knowledge-notes/",this.page.title="Heap-Exploitation-base-knowledge-notes"},d=document,s=d.createElement("script");s.src="https://F1r-github-io.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){var r=!1,s=0,a=0,i=n.title.trim(),c=i.toLowerCase(),l=n.content.trim().replace(/<[^>]+>/g,""),h=l.toLowerCase(),p=decodeURIComponent(n.url),u=[],f=[];if(""!=i&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}u=u.concat(e(t,c,!1)),f=f.concat(e(t,h,!1))}),(u.length>0||f.length>0)&&(r=!0,s=u.length+f.length)),r){[u,f].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});function d(e,o,n,r){for(var s=r[r.length-1],i=s.position,c=s.word,l=[],h=0;i+c.length<=n&&0!=r.length;){c===t&&h++,l.push({position:i,length:c.length});var p=i+c.length;for(r.pop();0!=r.length&&(s=r[r.length-1],i=s.position,c=s.word,p>i);)r.pop()}return a+=h,{hits:l,start:o,end:n,searchTextCount:h}}var g=[];0!=u.length&&g.push(d(0,0,i.length,u));for(var v=[];0!=f.length;){var $=f[f.length-1],C=$.position,m=$.word,x=C-20,w=C+80;x<0&&(x=0),w<C+m.length&&(w=C+m.length),w>l.length&&(w=l.length),v.push(d(0,x,w,f))}v.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var y=parseInt("1");y>=0&&(v=v.slice(0,y));function T(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var b="";b+=0!=g.length?"<li><a href='"+p+"' class='search-result-title'>"+T(i,g[0])+"</a>":"<li><a href='"+p+"' class='search-result-title'>"+i+"</a>",v.forEach(function(t){b+="<a href='"+p+'\'><p class="search-result">'+T(l,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:a,hitCount:s,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),!1===isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){27===t.which&&$(".search-popup").is(":visible")&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css"><script src="/lib/needsharebutton/needsharebutton.js"></script><script>pbOptions={},pbOptions.iconStyle="box",pbOptions.boxForm="horizontal",pbOptions.position="bottomCenter",pbOptions.networks="Weibo,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-postbottom",pbOptions),flOptions={},flOptions.iconStyle="box",flOptions.boxForm="horizontal",flOptions.position="middleRight",flOptions.networks="Weibo,Douban,QQZone,Twitter,Facebook",new needShareButton("#needsharebutton-float",flOptions)</script><script type="text/javascript" src="/live2d/script.js"></script><canvas id="live2dcanvas" width="200" height="400" class="live2d"></canvas><style>#live2dcanvas{position:fixed;right:0;z-index:999;pointer-events:none;bottom:-20px}</style><script>loadlive2d("live2dcanvas","/live2d/assets/miku/miku.model.json",.5)</script></body></html>